<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/svg+xml"
    href='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><rect rx="12" ry="12" width="64" height="64" fill="%23fbbf24"/><path d="M18 20h28v4H18zm0 10h28v4H18zm0 10h18v4H18z" fill="%231f2937"/></svg>' />
  <link rel="stylesheet" href="styles/style.css">
  <link rel="stylesheet" href="styles/two-base.css">
  <link rel="stylesheet" href="styles/toolbar-highlight.css">
  <link rel="stylesheet" href="styles/settings.css">
  <link rel="stylesheet" href="styles/question-base.css?v=3">
  <link rel="stylesheet" href="styles/dungeon-base.css">
  <link rel="stylesheet" href="styles/dungeon-footer.css">
  <link rel="stylesheet" href="styles/dungeon-note.css">
  <link rel="stylesheet" href="styles/toast.css">
  <link rel="stylesheet" href="styles/notif-center.css">
  <!-- Startup and reload sounds removed -->
  <style>
    /* View Options Menu */
    .view-options-menu {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      min-width: 200px;
      z-index: 1001;
      overflow: hidden;
    }

    .view-options-section {
      padding: 0.5rem;
    }

    .view-options-label {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 0.5rem 0.75rem;
      margin-bottom: 0.25rem;
    }

    .view-option-btn {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.6rem 0.75rem;
      border: none;
      border-radius: 6px;
      background: transparent;
      color: var(--text);
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s;
      text-align: left;
    }

    .view-option-btn:hover {
      background: var(--hover);
    }

    .view-option-btn.active {
      background: var(--accent-bg);
      color: var(--accent);
      font-weight: 500;
    }

    .view-option-btn svg {
      flex-shrink: 0;
    }

    .view-options-divider {
      height: 1px;
      background: var(--border);
      margin: 0.5rem 0;
    }
  </style>
  <title>Qnex</title>
</head>

<body>


  <!-- Loading Spinner -->
  <!-- Modern System Loader -->
  <div id="appLoader" class="app-loader">
    <div class="loader-content">
      <div class="loader-header">
        <div class="loader-logo">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
            <polyline points="10 9 9 9 8 9"></polyline>
          </svg>
        </div>
        <div class="loader-title">
          <h1>Qnex</h1>
          <span>APP BOOT</span>
        </div>
      </div>

      <div class="loader-status-bar">
        <div id="loaderProgress" class="loader-progress"></div>
      </div>

      <div id="loaderTerminal" class="loader-terminal">
        <div class="terminal-line info">Initialize system core...</div>
      </div>

      <button id="loaderRetryBtn">RETRY CONNECTION</button>
    </div>
  </div>

  <!-- Connection Status Indicator (Legacy - Hidden) -->
  <div id="connectionStatus" style="display: none !important;"></div>

  <div id="app">
    <aside id="sidebar" class="sidebar">
      <!-- Sidebar Header with Settings on Left and Action Menu on Right -->
      <div class="sidebar-header">
        <button id="settingsBtn" class="icon-btn" title="Settings" style="margin-left: -12px; padding-left: 6px;">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path
              d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z">
            </path>
            <circle cx="12" cy="12" r="3"></circle>
          </svg>
        </button>
        <div class="sidebar-action-menu" style="margin-left: auto;">
          <button id="sidebarActionBtn" class="sidebar-action-btn" title="Add or Import" style="margin-right: -6px;">
            <svg class="action-plus-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
              stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
          </button>
          <div class="sidebar-action-menu-content" id="sidebarActionMenu">
            <button id="newNoteBtn" class="menu-item new-note-item">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
              </svg>
              New Note
            </button>
            <button class="menu-item new-folder-item" data-cmd="new-folder">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                <line x1="12" y1="11" x2="12" y2="17"></line>
                <line x1="9" y1="14" x2="15" y2="14"></line>
              </svg>
              New Folder
            </button>
            <button class="menu-item import-item" data-cmd="import-root">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
              </svg>
              Import
            </button>
            <button class="menu-item" id="openQuestionsBtn">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <line x1="10" y1="9" x2="8" y2="9"></line>
              </svg>
              Question Bank
            </button>
          </div>
        </div>
      </div>

      <!-- Scrollable Content Area -->
      <div class="sidebar-content">
        <!-- Notebooks Section -->
        <div class="sidebar-section">
          <div class="sidebar-section-header-text" data-section="notebooks">
            <svg class="section-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
              stroke-width="2">
              <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
              <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
            </svg>
            <span>Notebooks</span>
            <svg class="section-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
              stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="sidebar-section-content" id="notebooksContent">
            <!-- Notebooks will be dynamically populated -->
            <div class="sidebar-empty-state" style="display: none;">No notebooks</div>
          </div>
        </div>

        <!-- Pinned Notes Section -->
        <div class="sidebar-section" id="pinnedNotesSection">
          <div class="sidebar-section-header-text" data-section="pinned">
            <svg class="section-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
              stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 17v5"></path>
              <path d="M9 10V5a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v5"></path>
              <path d="M9 14h6"></path>
              <path d="M9 10h6a1 1 0 0 1 1 1v3H8v-3a1 1 0 0 1 1-1z"></path>
            </svg>
            <span>Pinned</span>
            <svg class="section-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
              stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="sidebar-section-content" id="pinnedNotesContent">
            <!-- Pinned notes will be dynamically populated -->
            <div class="sidebar-empty-state" style="display: none;">No pinned notes</div>
          </div>
        </div>

        <!-- Folders Section -->
        <div class="sidebar-section">
          <div class="sidebar-section-header-text" data-section="folders">
            <svg class="section-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
              stroke-width="2">
              <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
            </svg>
            <span>Folders</span>
            <svg class="section-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
              stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="sidebar-section-content" id="foldersContent">
            <!-- Folders will be dynamically populated -->
            <div class="sidebar-empty-state" style="display: none;">No folders</div>
          </div>
        </div>

        <!-- Original Note List (hidden by default, used for search results) -->
        <div id="noteList" class="note-list" style="display: none;"></div>
      </div>

      <!-- Search Bar at Bottom (Sticky) -->
      <div class="sidebar-search">
        <div class="sidebar-search-wrapper">
          <input type="text" id="searchInput" placeholder="Search notes, titles, folders, tags..." autocomplete="off" />
          <button id="clearSearch" class="clear-search" title="Clear search">
            ×
          </button>
        </div>
        <button class="editor-trash-btn icon-btn" title="Trash">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 6h18" />
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            <line x1="10" y1="11" x2="10" y2="17"></line>
            <line x1="14" y1="11" x2="14" y2="17"></line>
          </svg>
        </button>
      </div>
      <div id="sidebarResizer" class="sidebar-resizer" title="Drag to resize"></div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="topbar-left">
          <button id="toggleSidebarBtn" class="icon-btn" title="Toggle sidebar">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="9" y1="3" x2="9" y2="21"></line>
            </svg>
          </button>
          <button id="homeBtn" class="icon-btn" title="Home">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
              <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
          </button>
          <div id="dock" class="dock" title="Minimized windows"></div>
        </div>
        <div class="top-actions">
          <!-- Hidden tools menu buttons for functionality -->
          <div style="display: none">
            <button id="duplicateBtn"></button>
            <button id="deleteBtn"></button>
            <button id="trashBtn">
              <span class="trash-text">Trash</span>
            </button>
            <button id="exportBtn"></button>
            <button id="importBtn"></button>
            <button id="exportHtmlBtn"></button>
            <button id="exportPdfBtn"></button>
          </div>
          <button data-action="open-browser" title="Open Browser" class="browser-btn icon-btn" style="display: none;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10" />
              <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" />
              <path d="M2 12h20" />
            </svg>
          </button>

          <!-- Open Notes Drawer Button (to the right of settings) -->
          <button id="openNotesDrawerBtn" class="icon-btn" title="Open notes">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
          </button>
        </div>
      </div>



      <!-- MAIN BASE: Workspace Split for browsing folders/notes -->
      <section class="workspace-split" id="workspaceSplit">
        <!-- Breadcrumb Navigation -->
        <div class="breadcrumb-nav">
          <div class="breadcrumb-left">
            <button id="breadcrumbBack" class="breadcrumb-back" style="display: none;">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"></polyline>
              </svg>

            </button>
            <div class="breadcrumb-path" id="breadcrumbPath">All Notes</div>
          </div>

          <!-- Toolbar Actions -->
          <div class="breadcrumb-actions">
            <!-- Search Button -->
            <button id="searchBtn" class="icon-btn" title="Search">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
              </svg>
            </button>

            <!-- Multi-Selection Button -->
            <button id="multiSelectBtn" class="icon-btn" title="Multi-select">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 11l3 3L22 4"></path>
                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
              </svg>
            </button>

            <!-- Sort Button (A-Z / Z-A) -->
            <button id="sortBtn" class="icon-btn" title="Sort A-Z" data-sort="asc">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="m3 8 4-4 4 4"></path>
                <path d="M7 4v16"></path>
                <path d="M11 12h10"></path>
                <path d="M11 16h7"></path>
                <path d="M11 20h4"></path>
              </svg>
            </button>

            <!-- View Toggle Button -->
            <button id="viewToggleBtn" class="icon-btn" title="Grid view" data-view="grid">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="7" height="7"></rect>
                <rect x="14" y="3" width="7" height="7"></rect>
                <rect x="3" y="14" width="7" height="7"></rect>
                <rect x="14" y="14" width="7" height="7"></rect>
              </svg>
            </button>
          </div>
        </div>

        <!-- Workspace Content (folder/note grid) -->
        <div class="workspace-content" id="workspaceContent">
          <!-- Dynamically populated with folders and notes -->
        </div>
      </section>



      <!-- NOTE BASE: Fullscreen overlay for editing notes -->
      <section class="note-base hidden" id="noteBase">
        <!-- Note Header with tabs and back button -->
        <div class="note-header">
          <div class="note-header-left">
            <button id="backToMain" class="icon-btn" title="Back to Notes">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"></polyline>
              </svg>
            </button>
            <div class="note-tabs" id="noteTabs"></div>
          </div>

          <div class="note-header-right">
            <!-- Toolbar Options Button -->
            <button id="toolbarOptionsBtn" class="icon-btn" title="Toolbar Options">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" stroke="none">
                <circle cx="12" cy="5" r="2"></circle>
                <circle cx="12" cy="12" r="2"></circle>
                <circle cx="12" cy="19" r="2"></circle>
              </svg>
            </button>

            <!-- Toolbar Options Dropdown -->
            <div id="toolbarOptionsMenu" class="toolbar-options-menu hidden">
              <div class="toolbar-options-section">
                <div class="toolbar-options-label">Toolbar Position</div>
                <div class="toolbar-position-grid">
                  <button class="toolbar-position-btn" data-position="top" title="Top">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                      <rect x="2" y="2" width="20" height="4" rx="1"></rect>
                      <rect x="2" y="8" width="20" height="14" rx="1" opacity="0.3"></rect>
                    </svg>
                  </button>
                  <button class="toolbar-position-btn" data-position="bottom" title="Bottom">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                      <rect x="2" y="2" width="20" height="14" rx="1" opacity="0.3"></rect>
                      <rect x="2" y="18" width="20" height="4" rx="1"></rect>
                    </svg>
                  </button>
                </div>
              </div>

              <div class="toolbar-options-divider"></div>

              <div class="toolbar-options-section">
                <div class="toolbar-options-label">Toolbar Alignment</div>
                <div class="toolbar-align-buttons">
                  <button class="toolbar-align-btn" data-align="left" title="Align Left">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="3" y1="6" x2="15" y2="6"></line>
                      <line x1="3" y1="12" x2="21" y2="12"></line>
                      <line x1="3" y1="18" x2="15" y2="18"></line>
                    </svg>
                  </button>
                  <button class="toolbar-align-btn" data-align="center" title="Align Center">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="6" y1="6" x2="18" y2="6"></line>
                      <line x1="3" y1="12" x2="21" y2="12"></line>
                      <line x1="6" y1="18" x2="18" y2="18"></line>
                    </svg>
                  </button>
                  <button class="toolbar-align-btn" data-align="right" title="Align Right">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="9" y1="6" x2="21" y2="6"></line>
                      <line x1="3" y1="12" x2="21" y2="12"></line>
                      <line x1="9" y1="18" x2="21" y2="18"></line>
                    </svg>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Content Container (toolbar + editors) -->
        <div class="note-content-container">
          <!-- Note Toolbar Section (separate from tabs) -->
          <div class="note-toolbar-section">
            <div class="note-toolbar" id="noteToolbar"></div>

            <!-- Note Search Container - inside toolbar, pushed to right -->
            <div class="note-search-container hidden" id="noteSearchContainer">
              <div class="note-search-box">
                <div class="note-search-input-wrapper">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                  </svg>
                  <input type="text" id="noteSearchInput" placeholder="Find in note..." autocomplete="off">
                </div>
                <div class="note-search-stats" id="noteSearchStats">0 of 0</div>
                <div class="note-search-divider"></div>
                <div class="note-search-buttons">
                  <button id="noteSearchPrev" class="note-search-btn" title="Previous (Shift+Enter)">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="18 15 12 9 6 15"></polyline>
                    </svg>
                  </button>
                  <button id="noteSearchNext" class="note-search-btn" title="Next (Enter)">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                  </button>
                  <button id="noteSearchClose" class="note-search-btn" title="Close (Esc)">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="18" y1="6" x2="6" y2="18"></line>
                      <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Note Editors Container (supports split view) -->
          <div class="note-editors" id="noteEditors">
            <div class="note-pane" data-pane="left" id="notePane-left">
              <div class="note-pane-content"></div>
            </div>
            <div id="noteResizer" class="note-resizer hidden" title="Drag to resize"></div>
            <div class="note-pane hidden" data-pane="right" id="notePane-right">
              <div class="note-pane-content"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- QUESTION BASE: Fullscreen overlay for creating MCQs -->
      <section class="question-base hidden" id="questionBase">
        <aside class="sidebar question-sidebar" id="questionSidebar">
          <!-- Sidebar Header -->
          <div class="sidebar-header">
            <button id="backToMainFromQuestions" class="icon-btn" title="Back"
              style="margin-left: -12px; padding-left: 6px;">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"></polyline>
              </svg>
            </button>
            <span
              style="font-size: 0.85rem; color: var(--muted); font-weight: 500; margin-left: 10px; margin-right: auto;">Question
              Bank</span>

            <div class="sidebar-action-menu" style="margin-left: auto;">
              <button id="questionActionBtn" class="sidebar-action-btn" title="New Question"
                style="margin-right: -6px;">
                <svg class="action-plus-icon" width="20" height="20" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2">
                  <line x1="12" y1="5" x2="12" y2="19"></line>
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
              </button>
            </div>
          </div>

          <!-- Sidebar Content -->
          <div class="sidebar-content">
            <div id="questionList">
              <!-- Sections will be rendered by JavaScript -->
            </div>
          </div>

          <!-- Sidebar Search (Sticky) -->
          <div class="sidebar-search">
            <div class="sidebar-search-wrapper">
              <input type="text" id="questionSearchInput" placeholder="Search questions..." autocomplete="off" />
              <button id="clearQuestionSearch" class="clear-search" title="Clear search">×</button>
            </div>
            <button class="editor-trash-btn icon-btn" title="Trash"> <!-- Placeholder for now -->
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 6h18" />
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                <line x1="10" y1="11" x2="10" y2="17"></line>
                <line x1="14" y1="11" x2="14" y2="17"></line>
              </svg>
            </button>
          </div>

          <!-- Resizer -->
          <div id="questionSidebarResizer" class="sidebar-resizer" title="Drag to resize"></div>
        </aside>

        <main class="question-content" id="questionContent">
          <!-- Persistent Header -->
          <div class="question-header">
            <div style="display: flex; align-items: center; gap: 8px;">
              <button id="backToMainFromQuestionsHeader" class="icon-btn" title="Back to Notes" style="display: none;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
              </button>
            <button id="toggleQuestionSidebarBtn" class="icon-btn" title="Toggle Sidebar">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="9" y1="3" x2="9" y2="21"></line>
                </svg>
              </button>
            </div>
            
            <!-- Center Actions -->
            <div class="header-center" style="position: absolute; left: 50%; transform: translateX(-50%);">
               <button id="createSessionBtn" class="icon-btn" title="Create Session" style="gap: 6px; padding: 4px 12px; width: auto; font-size: 0.9rem;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <text x="1" y="16" font-size="13" font-weight="bold" fill="currentColor" stroke="none">Aa</text>
                  <line x1="19" y1="4" x2="19" y2="20"></line>
                </svg>
                <span>Manual Session </span>
              </button>
            </div>

            <!-- Right Actions -->
            <div class="header-tools" style="display: flex; align-items: center; gap: 8px;">
              <button id="playQuestionsBtn" class="icon-btn" title="Start Exam Mode">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polygon points="5 3 19 12 5 21 5 3"></polygon>
                </svg>
              </button>
            </div>
          </div>

          <!-- Breadcrumb Nav -->
          <div class="breadcrumb-nav">
            <div class="breadcrumb-left" style="flex: 1; padding-right: 10px; display: flex; align-items: center; justify-content: center; gap: 12px;">
              <button id="backToEmptyStateBtn" class="icon-btn" title="Back" style="display: none;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M15 18l-6-6 6-6"/>
                </svg>
              </button>
              
              <!-- Tab Navigation -->
              <div id="qbankTabNav" class="qbank-tab-nav" style="display: flex; gap: 4px;">
                <button class="qbank-tab active" data-tab="main">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                  </svg>
                  Main
                </button>
                <button class="qbank-tab" data-tab="statistics">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 20V10M12 20V4M6 20v-6"></path>
                  </svg>
                  Statistics
                </button>
                <button class="qbank-tab" data-tab="create-test">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="12" y1="8" x2="12" y2="16"></line>
                    <line x1="8" y1="12" x2="16" y2="12"></line>
                  </svg>
                  Create Test
                </button>
                <button class="qbank-tab" data-tab="recent-sessions">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 8v4l3 3m6-3a9 9 0 1 1-6.219-8.56"></path>
                  </svg>
                  Recent Sessions
                </button>
              </div>
              
              <input type="text" id="questionTitleInput" placeholder="Select a question or create new"
                class="question-title-input" disabled
                style="width: 100%; border: none; background: transparent; font-size: 1.1em; font-weight: 600; outline: none; color: var(--text); display: none;">
            </div>
            <div class="breadcrumb-actions">
              <button id="saveQuestionBtn" class="icon-btn" title="Save Question" disabled style="display:none;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                  <polyline points="17 21 17 13 7 13 7 21"></polyline>
                  <polyline points="7 3 7 8 15 8"></polyline>
                </svg>
              </button>
            </div>
          </div>

          <div class="question-editor-container hidden" id="questionEditor">
            <!-- Header Moved Out -->

            <div class="question-body">
              <div class="form-group">
                <label>Question Text</label>
                <div id="questionTextInput" class="rich-input" contenteditable="true"></div>
              </div>

              <div class="options-container" id="optionsContainer">
                <label>Answer Options</label>
                <!-- Options will be generated here -->
              </div>

              <button id="addOptionBtn" class="btn secondary small" style="margin-top: 10px;">+ Add Option</button>

              <div class="form-group" style="margin-top: 20px;">
                <label>Explanation (Optional)</label>
                <textarea id="questionExplanation"
                  placeholder="Explain why the correct answer is correct..."></textarea>
              </div>
            </div>
          </div>
          
          <div id="questionEmptyState" class="question-empty-state">
            <!-- Dynamic Content Viewer -->
            <div class="empty-state-content" id="emptyStateContentViewer">
              <!-- Main Tab Content -->
              <div class="tab-content active" data-tab-content="main">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"
                  stroke-linecap="round" stroke-linejoin="round">
                  <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                  <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                </svg>
                <h3>No Question Selected</h3>
                <p>Select a question from the sidebar to view details, or create a new one.</p>
              </div>

              <!-- Statistics Tab Content -->
              <div class="tab-content" data-tab-content="statistics">
                <div class="statistics-container">
                  <div class="stats-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div class="stats-title-group">
                      <h2>Knowledge Dashboard</h2>
                      <p>System metrics and performance analysis</p>
                    </div>
                    <button id="syncStatsBtn" class="icon-btn" title="Sync & Recalculate Statistics" style="background:none; border:none; padding:8px; display:flex; align-items:center; justify-content:center; margin-top:18px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 4v6h-6"></path>
                        <path d="M1 20v-6h6"></path>
                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                      </svg>
                    </button>
                  </div>
                  
                  <div class="stats-dashboard">

                    <!-- Row 1: Score -->
                    <div class="stats-row">
                      <!-- Donut: Correct % -->
                      <div class="stats-donut-wrap">
                        <svg class="stats-donut" viewBox="0 0 120 120">
                          <circle class="donut-track" cx="60" cy="60" r="50"/>
                          <circle class="donut-fill" id="donutCorrect" cx="60" cy="60" r="50" stroke-dasharray="0 314"/>
                        </svg>
                        <div class="donut-label">
                          <span class="donut-pct" id="stat-accuracy">0%</span>
                          <span class="donut-sub">Correct</span>
                        </div>
                      </div>

                      <!-- Your Score -->
                      <div class="stats-group">
                        <div class="stats-group-title">Your Score</div>
                        <div class="stats-row-item">
                          <span class="stats-row-label">Total Correct</span>
                          <span class="stats-row-badge green" id="stat-correct">0</span>
                        </div>
                        <div class="stats-row-item">
                          <span class="stats-row-label">Total Incorrect</span>
                          <span class="stats-row-badge red" id="stat-incorrect">0</span>
                        </div>
                        <div class="stats-row-item">
                          <span class="stats-row-label">Total Omitted</span>
                          <span class="stats-row-badge" id="stat-omitted">0</span>
                        </div>
                        <div class="stats-row-item">
                          <span class="stats-row-label">Average Time Spent</span>
                          <span class="stats-row-badge" id="stat-avg-time">0</span>
                        </div>
                      </div>

                      <div class="stats-graph-container">
                        <div class="graph-main">
                          <div class="graph-bar-wrap">
                            <div class="graph-bar green" id="barCorrect" style="height: 0%;">
                              <span class="bar-value" id="barValueCorrect">0</span>
                            </div>
                            <span class="bar-label">Correct</span>
                          </div>
                          <div class="graph-bar-wrap">
                            <div class="graph-bar red" id="barIncorrect" style="height: 0%;">
                              <span class="bar-value" id="barValueIncorrect">0</span>
                            </div>
                            <span class="bar-label">Incorrect</span>
                          </div>
                        </div>
                      </div>

                    </div>

                    <div class="stats-divider"></div>

                    <!-- Row 2: QBank -->
                    <div class="stats-row">
                      <!-- Donut: Used % -->
                      <div class="stats-donut-wrap">
                        <svg class="stats-donut" viewBox="0 0 120 120">
                          <circle class="donut-track" cx="60" cy="60" r="50"/>
                          <circle class="donut-fill" id="donutUsed" cx="60" cy="60" r="50" stroke-dasharray="0 314"/>
                        </svg>
                        <div class="donut-label">
                          <span class="donut-pct" id="stat-used-pct">0%</span>
                          <span class="donut-sub">Used</span>
                        </div>
                      </div>

                      <!-- QBank Usage -->
                      <div class="stats-group">
                        <div class="stats-group-title">QBank Usage</div>
                        <div class="stats-row-item">
                          <span class="stats-row-label">Used Questions</span>
                          <span class="stats-row-badge" id="stat-used-q">0</span>
                        </div>
                        <div class="stats-row-item">
                          <span class="stats-row-label">Unused Questions</span>
                          <span class="stats-row-badge" id="stat-unused-q">0</span>
                        </div>
                        <div class="stats-row-item">
                          <span class="stats-row-label">Total Questions</span>
                          <span class="stats-row-badge" id="stat-total-questions">0</span>
                        </div>
                      </div>

                        <div class="stats-group">
                          <div class="stats-group-title">Test Activity</div>
                          <div class="stats-row-item">
                            <span class="stats-row-label">Tests Created</span>
                            <span class="stats-row-badge" id="stat-total-folders">0</span>
                          </div>
                          <div class="stats-row-item">
                            <span class="stats-row-label">Tests Completed</span>
                            <span class="stats-row-badge" id="stat-total-sessions">0</span>
                          </div>
                          <div class="stats-row-item">
                            <span class="stats-row-label">Tests Suspended</span>
                            <span class="stats-row-badge" id="stat-suspended">0</span>
                          </div>
                        </div>
                      </div>

                      </div>
                    </div>
                  </div>

                <!-- Create Test Tab Content -->
                <div class="tab-content" data-tab-content="create-test">
                  <div class="statistics-container ct-page">

                    <!-- Page Header -->
                    <div class="stats-header" style="display:flex;justify-content:space-between;align-items:flex-start;">
                      <div class="stats-title-group">
                        <h2>Create Test</h2>
                        <p>Filter by tags, configure your session, and launch</p>
                      </div>
                      <div class="ct-header-actions" style="display:flex; gap:8px; align-items:center; margin-top: 40px;">
                        <button id="ctRefreshBtn" class="icon-btn" title="Refresh syncing tags" style="background:none; border:none; padding:0; display:flex; align-items:center; justify-content:center; height:34px; min-width:34px;">
                          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
                        </button>
                        <button id="ctAutoTagBtn" class="icon-btn" title="Auto-assign tags from question content" style="background:none; border:none; padding:0; display:flex; align-items:center; justify-content:center; height:34px; min-width:34px;">
                          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>
                        </button>
                      </div>
                    </div>

                    <div class="ct-layout">

                      <!-- LEFT: Filter Panel -->
                      <div class="ct-left">

                        <!-- Tag Filters -->
                        <div class="ct-section ct-centered">
                          <div class="ct-section-title">
                            Filter by Tags
                          </div>
                          <p class="ct-section-hint">Only questions with matching tags will be included</p>

                          <div class="ct-category-row">
                            <div class="ct-cat-wrap">
                              <button class="ct-cat-btn" id="ctBtnSubject">
                                <span>Subject</span>
                                <span class="ct-cat-badge" id="ctBadgeSubject"></span>
                              </button>
                            </div>
                            <div class="ct-cat-wrap">
                              <button class="ct-cat-btn" id="ctBtnSystem">
                                <span>System</span>
                                <span class="ct-cat-badge" id="ctBadgeSystem"></span>
                              </button>
                            </div>
                            <div class="ct-cat-wrap">
                              <button class="ct-cat-btn" id="ctBtnMajor">
                                <span>Major</span>
                                <span class="ct-cat-badge" id="ctBadgeMajor"></span>
                              </button>
                            </div>
                            <div class="ct-cat-wrap">
                              <button class="ct-cat-btn" id="ctBtnMinor">
                                <span>Minor</span>
                                <span class="ct-cat-badge" id="ctBadgeMinor"></span>
                              </button>
                            </div>
                          </div>

                          <button id="ctClearTags" class="ct-clear-btn" style="display:none;">
                            Clear all filters
                          </button>
                        </div>

                        <!-- ID Search -->
                        <div class="ct-section">
                          <div class="ct-section-title">
                            Load by IDs
                          </div>
                          <p class="ct-section-hint">Enter numeric IDs separated by commas <br/> (e.g. 121014, 121015, 121016, etc..)</p>
                          <div class="ct-id-search-wrap">
                            <span class="ct-id-prefix-fix">QNX-</span>
                            <input type="text" id="ctIdSearch" class="ct-id-input" placeholder="e.g. 121014" spellcheck="false">
                            <button id="ctIdSearchClear" class="ct-id-clear" title="Clear IDs" style="display:none;">×</button>
                          </div>
                          <div id="ctIdStatus" class="ct-id-status"></div>
                        </div>

                        <!-- Session Options -->
                        <div class="ct-section ct-centered">
                          <div class="ct-section-title">
                            Session Options
                          </div>

                          <!-- Number of Questions -->
                          <div class="ct-option-row">
                            <div class="ct-option-label">
                              Number of Questions
                            </div>
                            <div class="ct-qcount-wrap">
                              <input type="number" id="ctQcount" min="1" max="2387" value="10" class="ct-num-input">
                              <span class="ct-qcount-max-label">of <span id="ctMaxTotal">0</span> available</span>
                            </div>
                            <div class="ct-option-hint" id="ctQcountHint" style="display: none;">10 of — available</div>
                          </div>

                          <!-- Timer -->
                          <div class="ct-option-row">
                            <div class="ct-option-label">
                              Timer Mode
                            </div>
                            <div class="ct-toggle-group" id="ctTimerModeGroup">
                              <button class="ct-toggle-btn ct-toggle-active" data-val="off">Off</button>
                              <button class="ct-toggle-btn" data-val="up">Up (Elapsed)</button>
                              <button class="ct-toggle-btn" data-val="down">Down (Remain)</button>
                            </div>
                            <div class="ct-option-hint">Count time spent or time remaining</div>
                          </div>

                          <!-- Timer Sub-Options (Down Only) -->
                          <div id="ctTimerDownOptions" style="display: none; flex-direction: column; gap: 12px; margin-top: 8px;">
                            <div class="ct-option-row">
                              <div class="ct-option-label">Timer Scope</div>
                              <div class="ct-toggle-group" id="ctTimerScopeGroup">
                                <button class="ct-toggle-btn ct-toggle-active" data-val="question">Per Question</button>
                                <button class="ct-toggle-btn" data-val="session">Whole Session</button>
                              </div>
                            </div>
                            <div class="ct-option-row" id="ctTimerDurationRow">
                              <div class="ct-option-label">Duration</div>
                              <!-- Per Question Options -->
                              <div class="ct-toggle-group" id="ctTimerDurationGroupQuestion">
                                <button class="ct-toggle-btn" data-val="30">30s</button>
                                <button class="ct-toggle-btn ct-toggle-active" data-val="60">60s</button>
                                <button class="ct-toggle-btn" data-val="120">2m</button>
                                <button class="ct-toggle-btn" data-val="180">3m</button>
                                <button class="ct-toggle-btn" data-val="300">5m</button>
                              </div>
                              <!-- Whole Session Options -->
                              <div class="ct-session-timer-wrap" id="ctTimerDurationGroupSession" style="display: none; align-items: center; gap: 8px;">
                                <input type="number" id="ctTimerHr" min="0" max="99" value="1" class="ct-num-input" style="width: 50px;"> <span style="font-size: 12px; color: var(--text-muted);">hr</span>
                                <input type="number" id="ctTimerMin" min="0" max="59" value="0" class="ct-num-input" style="width: 50px;"> <span style="font-size: 12px; color: var(--text-muted);">min</span>
                                <input type="number" id="ctTimerSec" min="0" max="59" value="0" class="ct-num-input" style="width: 50px;"> <span style="font-size: 12px; color: var(--text-muted);">sec</span>
                              </div>
                              <div class="ct-option-hint">Set duration for your timer</div>
                            </div>
                          </div>

                          <!-- Tutor Mode -->
                          <div class="ct-option-row">
                            <div class="ct-option-label">
                              Tutor Mode
                            </div>
                            <div class="ct-toggle-group" id="ctTutorGroup">
                              <button class="ct-toggle-btn ct-toggle-active" data-val="on">On</button>
                              <button class="ct-toggle-btn" data-val="off">Off</button>
                            </div>
                            <div class="ct-option-hint">Show explanation after each answer</div>
                          </div>

                          <!-- Shuffle -->
                          <div class="ct-option-row">
                            <div class="ct-option-label">
                              Shuffle Questions
                            </div>
                            <div class="ct-toggle-group" id="ctShuffleGroup">
                              <button class="ct-toggle-btn" data-val="on">On</button>
                              <button class="ct-toggle-btn ct-toggle-active" data-val="off">Off</button>
                            </div>
                            <div class="ct-option-hint">Randomize question order</div>
                          </div>
                        </div>

                      </div>

                      <!-- RIGHT: Preview Panel -->
                      <div class="ct-right">
                        <div class="ct-section ct-preview-section">
                          <div class="ct-section-title">
                            Matching Questions
                          </div>

                          <!-- Stats row -->
                          <div class="ct-preview-stats">
                            <div class="ct-stat-box">
                              <span class="ct-stat-num" id="ctMatchTotal">—</span>
                              <span class="ct-stat-label">Total Tagged</span>
                            </div>
                            <div class="ct-stat-box">
                              <span class="ct-stat-num ct-stat-accent" id="ctMatchFiltered">—</span>
                              <span class="ct-stat-label">Match Filters</span>
                            </div>
                            <div class="ct-stat-box">
                              <span class="ct-stat-num" id="ctMatchSelected">10</span>
                              <span class="ct-stat-label">Will Include</span>
                            </div>
                          </div>

                          <!-- Question List -->
                          <div class="ct-preview-list" id="ctPreviewList">
                            <div class="ct-preview-empty" id="ctPreviewEmpty">
                              <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2" style="opacity:0.25;margin-bottom:8px;"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/></svg>
                              <div>Select tags to preview matching questions</div>
                            </div>
                          </div>

                          <!-- Start Bar -->
                          <div class="ct-start-zone" id="ctStartZone" style="display:none;">
                            <div class="ct-start-summary" id="ctStartSummary"></div>
                            <button class="ct-start-btn" id="ctStartSessionBtn">
                              Create Test
                            </button>
                          </div>
                        </div>
                      </div>

                    </div>
                  </div>
                </div>

              <!-- Recent Sessions Tab Content -->
              <div class="tab-content" data-tab-content="recent-sessions">
                <div class="statistics-container">
                  <div class="stats-header">
                    <div class="stats-title-group">
                      <h2>Previous Journeys</h2>
                      <p>Review and resume your previous learning sessions</p>
                    </div>
                  </div>

                  <div class="sessions-management-toolbar">
                    <div class="toolbar-search">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                      </svg>
                      <input type="text" id="sessionsSearchInput" placeholder="Search sessions...">
                    </div>
                    
                    <div class="toolbar-actions">
                      <div class="sort-control">
                        <span>Sort by:</span>
                        <select id="sessionsSortSelect">
                          <option value="newest">Newest</option>
                          <option value="oldest">Oldest</option>
                          <option value="name">Name</option>
                          <option value="questions">Questions</option>
                        </select>
                      </div>
                      
                      <div class="view-toggle-group">
                        <button id="viewListBtn" class="view-btn active" title="List View">List</button>
                        <button id="viewGridBtn" class="view-btn" title="Grid View">Grid</button>
                      </div>
                    </div>
                  </div>
                  
                  <div id="recentSessionsList" class="recent-sessions-grid">
                    <!-- Sessions rendered here -->
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Session Creator -->
          <div id="sessionCreator" class="session-creator hidden">
            <div class="session-creator-toolbar">
               <div class="session-creator-actions-left">
                  <button id="addSessionQBtn" class="icon-btn" title="Add Question Template">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="12" y1="5" x2="12" y2="19"></line>
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                  </button>
                  <button id="clearSessionBtn" class="icon-btn danger" title="Delete Last Question">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                       <path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"></path>
                       <line x1="18" y1="9" x2="12" y2="15"></line>
                       <line x1="12" y1="9" x2="18" y2="15"></line>
                    </svg>
                  </button>
                  <button id="restoreSessionQBtn" class="icon-btn" title="Restore Deleted Question">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                       <path d="M3 10h10a5 5 0 0 1 5 5v2"></path>
                       <polyline points="8 5 3 10 8 15"></polyline>
                    </svg>
                  </button>
                  <button id="toggleAiModeBtn" class="icon-btn" title="AI mode" style="margin-left: -4px;">
                   <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <!-- Main large sparkle star -->
                      <path d="M12 3l1.912 5.813a2 2 0 001.275 1.275L21 12l-5.813 1.912a2 2 0 00-1.275 1.275L12 21l-1.912-5.813a2 2 0 00-1.275-1.275L3 12l5.813-1.912a2 2 0 001.275-1.275L12 3z"/>
                      <!-- Small sparkle bottom-right -->
                      <path d="M19 16l.6 1.4 1.4.6-1.4.6-.6 1.4-.6-1.4-1.4-.6 1.4-.6.6-1.4z" fill="currentColor" stroke="none"/>
                    </svg>
                  </button>
                  <button id="fillAiBtn" class="icon-btn" title="Generate questions" style="display: none;">
                    <svg width="18" height="18" viewBox="-2 -2 28 28" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
                      <!-- Base screw lines -->
                      <path d="M9 21h6"/>
                      <path d="M9.5 19h5"/>
                      <path d="M10 17.5h4"/>
                      <!-- Main bulb shape -->
                      <path d="M12 2a7 7 0 0 1 4.95 11.95l-.548.547A3.374 3.374 0 0 0 15 16.969V17.5H9v-.531a3.374 3.374 0 0 0-.988-2.386l-.548-.547A7 7 0 0 1 12 2z"/>
                      <!-- Light rays (taller, further away) -->
                      <line x1="12" y1="-1.5" x2="12" y2="0.5"/>
                      <line x1="20.5" y1="3.2" x2="19.2" y2="4.5"/>
                      <line x1="3.5" y1="3.2" x2="4.8" y2="4.5"/>
                      <line x1="23.5" y1="12" x2="21.5" y2="12"/>
                      <line x1="0.5" y1="12" x2="2.5" y2="12"/>
                    </svg>
                  </button>
                  <button id="uploadMediaBtn" class="icon-btn" title="Upload PDF/Media" style="display: none;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                      <polyline points="14 2 14 8 20 8"></polyline>
                      <line x1="12" y1="18" x2="12" y2="12"></line>
                      <line x1="9" y1="15" x2="15" y2="15"></line>
                    </svg>
                  </button>
                  <button id="viewAiPromptBtn" class="icon-btn" title="View AI Prompt" style="margin-left: 4px; display: none;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"></path>
                    </svg>
                  </button>
                  <span id="uploadedFileStatus" style="display: none; margin-left: 8px; font-size: 11px; color: var(--muted); align-items: center; gap: 4px;">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                      <polyline points="14 2 14 8 20 8"></polyline>
                    </svg>
                    <span id="uploadedFileName"></span>
                  </span>
                  
                  <!-- Model Selector -->
                  <select id="aiModelSelector" class="model-selector" style="display: none; margin-left: 8px;">
                    <option value="arcee-ai/trinity-large-preview:free">Trinity - Free</option>
                    <option value="google/gemini-2.0-flash-lite-preview-02-05:free">Gemini Flash 2.0 - Free</option>
                    <option value="meta-llama/llama-3.3-70b-instruct:free">Llama 3.3 70B - Premium</option>
                    <option value="stepfun/step-3.5-flash:free">Step 3.5 Flash - Free</option>
                    <option value="tngtech/deepseek-r1t2-chimera:free">DeepSeek R1 - Free</option>
                    <option value="google/gemini-2.0-pro-exp-02-05:free">Gemini 2.0 Pro - Premium</option>
                  </select>

                  <button id="ctRefreshBtn" class="icon-btn" title="Sync tags from content" style="margin-left: 8px;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M23 4v6h-6"></path>
                      <path d="M1 20v-6h6"></path>
                      <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                    </svg>
                  </button>

                  <!-- Tag Dropdowns: Subject / System / Major -->
                  <div class="tag-drop-wrapper" id="tagWrapSubject">
                    <button class="icon-btn tag-drop-btn" id="tagBtnSubject" title="Filter by Subject">
                      Subject <span class="tag-badge" id="tagBadgeSubject"></span>
                    </button>
                    <div class="tag-drop-menu hidden" id="tagMenuSubject"></div>
                  </div>
                  <div class="tag-drop-wrapper" id="tagWrapSystem">
                    <button class="icon-btn tag-drop-btn" id="tagBtnSystem" title="Filter by System">
                      System <span class="tag-badge" id="tagBadgeSystem"></span>
                    </button>
                    <div class="tag-drop-menu hidden" id="tagMenuSystem"></div>
                  </div>
                  <div class="tag-drop-wrapper" id="tagWrapMajor">
                    <button class="icon-btn tag-drop-btn" id="tagBtnMajor" title="Filter by Major">
                      Major <span class="tag-badge" id="tagBadgeMajor"></span>
                    </button>
                    <div class="tag-drop-menu hidden" id="tagMenuMajor"></div>
                  </div>
                  <div class="tag-drop-wrapper" id="tagWrapMinor">
                    <button class="icon-btn tag-drop-btn" id="tagBtnMinor" title="Filter by Minor">
                      Minor <span class="tag-badge" id="tagBadgeMinor"></span>
                    </button>
                    <div class="tag-drop-menu hidden" id="tagMenuMinor"></div>
                  </div>
                </div>
                <div class="session-creator-actions-right" style="display: flex; align-items: center; gap: 8px;">
                  <button id="cancelSessionBtn" class="icon-btn" title="Cancel">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="18" y1="6" x2="6" y2="18"></line>
                      <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                  </button>
                  <button id="startSessionBtn" class="icon-btn" title="Start Session" style="color: var(--accent);">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                  </button>
                </div>
              </div>

            <!-- Timer sub-options (shown only when Down is selected) -->
            <div id="sessionTimerSubOpts" style="display:flex; align-items:center; gap:10px; padding:4px 25px 6px; flex-wrap:wrap; font-size:11px;">
                  <!-- Session Options (compact) -->
                  <div class="session-inline-opts" style="display:flex; align-items:center; gap:6px; border-right:1px solid var(--border); padding-right:8px; margin-right:2px;">
                    <!-- Tutor toggle -->
                    <div style="display:flex; flex-direction:row; align-items:center; gap:6px;">
                      <span style="font-size:9px; color:var(--muted); letter-spacing:.03em; text-transform:uppercase;">Tutor</span>
                      <div class="ct-toggle-group session-toggle-group" id="sessionTutorGroup" style="gap:2px;">
                        <button class="ct-toggle-btn ct-toggle-active" data-val="on" style="padding:2px 7px; font-size:10px;">On</button>
                        <button class="ct-toggle-btn" data-val="off" style="padding:2px 7px; font-size:10px;">Off</button>
                      </div>
                    </div>
                    <!-- Shuffle toggle -->
                    <div style="display:flex; flex-direction:row; align-items:center; gap:6px;">
                      <span style="font-size:9px; color:var(--muted); letter-spacing:.03em; text-transform:uppercase;">Shuffle</span>
                      <div class="ct-toggle-group session-toggle-group" id="sessionShuffleGroup" style="gap:2px;">
                        <button class="ct-toggle-btn" data-val="on" style="padding:2px 7px; font-size:10px;">On</button>
                        <button class="ct-toggle-btn ct-toggle-active" data-val="off" style="padding:2px 7px; font-size:10px;">Off</button>
                      </div>
                    </div>
                    <!-- Timer toggle -->
                    <div style="display:flex; flex-direction:row; align-items:center; gap:6px;">
                      <span style="font-size:9px; color:var(--muted); letter-spacing:.03em; text-transform:uppercase;">Timer</span>
                      <div class="ct-toggle-group session-toggle-group" id="sessionTimerGroup" style="gap:2px;">
                        <button class="ct-toggle-btn ct-toggle-active" data-val="off" style="padding:2px 6px; font-size:10px;">Off</button>
                        <button class="ct-toggle-btn" data-val="up" style="padding:2px 6px; font-size:10px;">Up</button>
                        <button class="ct-toggle-btn" data-val="down" style="padding:2px 6px; font-size:10px;">Down</button>
                      </div>
                    </div>
                  </div>
               <div id="sessionTimerConfigInner" style="display:none; align-items:center; gap:10px;">
              <span style="color:var(--muted); font-size:10px; text-transform:uppercase; letter-spacing:.04em;">Scope:</span>
              <div class="ct-toggle-group session-toggle-group" id="sessionTimerScopeGroup" style="gap:2px;">
                <button class="ct-toggle-btn ct-toggle-active" data-val="question" style="padding:2px 8px; font-size:10px;">Per Question</button>
                <button class="ct-toggle-btn" data-val="session" style="padding:2px 8px; font-size:10px;">Whole Session</button>
              </div>
              <!-- Per-question duration buttons -->
              <div id="sessionTimerDurationQ" style="display:flex; align-items:center; gap:3px;">
                <span style="color:var(--muted); font-size:10px; margin-right:2px;">Duration:</span>
                <div class="ct-toggle-group session-toggle-group" style="gap:2px;">
                  <button class="ct-toggle-btn" data-val="30" style="padding:2px 6px; font-size:10px;">30s</button>
                  <button class="ct-toggle-btn ct-toggle-active" data-val="60" style="padding:2px 6px; font-size:10px;">60s</button>
                  <button class="ct-toggle-btn" data-val="120" style="padding:2px 6px; font-size:10px;">2m</button>
                  <button class="ct-toggle-btn" data-val="180" style="padding:2px 6px; font-size:10px;">3m</button>
                  <button class="ct-toggle-btn" data-val="300" style="padding:2px 6px; font-size:10px;">5m</button>
                </div>
              </div>
              <!-- Whole-session duration inputs -->
              <div id="sessionTimerDurationS" style="display:none; align-items:center; gap:4px;">
                <span style="color:var(--muted); font-size:10px; margin-right:2px;">Duration:</span>
                <input type="number" id="sessionTimerHr"  min="0" max="99" value="1" class="ct-num-input" style="width:42px; font-size:11px;">
                <span style="font-size:10px; color:var(--muted);">hr</span>
                <input type="number" id="sessionTimerMin" min="0" max="59" value="0" class="ct-num-input" style="width:42px; font-size:11px;">
                <span style="font-size:10px; color:var(--muted);">min</span>
                <input type="number" id="sessionTimerSec" min="0" max="59" value="0" class="ct-num-input" style="width:42px; font-size:11px;">
                <span style="font-size:10px; color:var(--muted);">sec</span>
              </div>
            </div>
            </div>


            <div class="session-editor-container">
               <div id="sessionInput" class="session-input" contenteditable="true" placeholder="Click '+ Add Question' to start..."></div>

               <!-- AI Loading Overlay -->
               <div id="aiLoadingOverlay" class="ai-loading-overlay hidden">
                 <div class="ai-spinner"></div>
                 <div class="ai-loading-text">AI is thinking...</div>
               </div>
            </div>
          </div>

        </main>
      </section>

      <!-- DUNGEON LAYER: Quiz/Practice Mode -->
      <section class="dungeon-base hidden" id="dungeonBase">
        <div class="dungeon-strip" id="dungeonStrip"></div>
        <button class="dungeon-close-btn" id="dungeonCloseBtn" title="Close">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
        <div class="dungeon-content">
          <div class="dungeon-card" id="dungeonCard">
            <!-- Question content rendered here -->
          </div>
        </div>
      </section>

      <!-- Float layer for windows -->
      <div id="float-layer" class="float-layer"></div>

      <!-- Empty state -->
      <div id="empty-state" class="empty-state hidden">
        <div class="empty-frame">
          <div class="empty-scroll-container" style="
                  padding-top: 100px;
                  overflow-y: scroll;
                  scrollbar-width: none;
                  -ms-overflow-style: none;
                ">
            <div class="ai-welcome">
              <div class="ai-greeting">Welcome Dr. Momen</div>
              <div class="welcome-shortcuts">
                <h4>Keyboard Shortcuts</h4>
                <div class="welcome-shortcuts-columns">
                  <div class="welcome-shortcuts-column">
                    <h5>Base Layer</h5>
                    <div class="welcome-shortcuts-grid">
                      <div><kbd>Ctrl+N</kbd> New note</div>
                      <div><kbd>Ctrl+F</kbd> Search notes</div>
                      <div><kbd>Ctrl+.</kbd> Toggle sidebar</div>
                      <div><kbd>F12</kbd> Fullscreen mode</div>
                      <div><kbd>Delete</kbd> Delete selected</div>
                      <div><kbd>Ctrl+Click</kbd> Multi-select</div>
                      <div><kbd>Esc</kbd> Close dialog</div>
                      <div><kbd>Enter</kbd> Confirm dialog</div>
                    </div>
                  </div>
                  <div class="welcome-shortcuts-column">
                    <h5>Note Layer</h5>
                    <div class="welcome-shortcuts-grid">
                      <div><kbd>Ctrl+S</kbd> Save note</div>
                      <div><kbd>Ctrl+B</kbd> Bold</div>
                      <div><kbd>Ctrl+U</kbd> Underline</div>
                      <div><kbd>Ctrl+H</kbd> Auto Highlight</div>
                      <div><kbd>Ctrl+O</kbd> Close tab</div>
                      <div><kbd>Ctrl+P</kbd> Close all</div>
                      <div><kbd>Ctrl+Scroll</kbd> Zoom text</div>
                      <div><kbd>- Space</kbd> Create bullet</div>
                      <div><kbd>1. Space</kbd> Create number list</div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="marquee-container">
                <div class="marquee-label">Notes Overview:</div>
                <div class="marquee-wrapper">
                  <div id="marquee-content" class="marquee-content"></div>
                </div>
              </div>
            </div>

            <div class="todo-section">
              <div class="todo-header">
                <h3>Today's Tasks</h3>
                <button id="addTaskBtn" class="btn-add-task" title="Add new task">
                  + Add Task
                </button>
              </div>
              <div class="todo-progress-container">
                <div class="progress-info">
                  <span id="progressText" class="progress-text">0% Complete</span>
                  <span id="progressStats" class="progress-stats">0 of 0 tasks</span>
                </div>
                <div class="progress-bar-wrapper">
                  <div id="progressBar" class="progress-bar" style="width: 0%"></div>
                </div>
              </div>
              <div id="todoList" class="todo-list"></div>
              <div id="todoInput" class="todo-input hidden">
                <input type="text" id="taskInput" placeholder="Enter task description..." />
                <div class="todo-input-actions">
                  <button id="saveTodoBtn" class="btn primary">Save</button>
                  <button id="cancelTodoBtn" class="btn">Cancel</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      </section>

      <!-- Workspace Footer Bar - DISABLED -->
      <!--
        <div class="workspace-footer" id="workspaceFooter">
          <button id="toggleWorkspaceBar" class="workspace-toggle-btn" title="Toggle workspace bar">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </button>
          <div id="workspaceTabs" class="workspace-tabs-list"></div>
          <button id="addWorkspaceBtn" class="workspace-tab-add" style="display: none;">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
          </button>
        </div>
        -->
    </main>
  </div>

  <input type="file" id="importInput" accept="application/json" class="hidden" />

  <template id="context-menu-template">
    <div class="ctx-menu">
      <div class="ctx-section" data-scope="tab">
        <button data-cmd="pin-tab">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="17" x2="12" y2="22"></line>
            <path
              d="M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V6h1a2 2 0 0 0 0-4H8a2 2 0 0 0 0 4h1v4.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24Z">
            </path>
          </svg>
          Pin Tab
        </button>
        <button data-cmd="close-tab">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
          Close Tab
        </button>
        <button data-cmd="close-other-tabs">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="15" y1="9" x2="9" y2="15"></line>
            <line x1="9" y1="9" x2="15" y2="15"></line>
          </svg>
          Close Other Tabs
        </button>
        <button data-cmd="close-all-tabs">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="7" height="7"></rect>
            <rect x="14" y="3" width="7" height="7"></rect>
            <rect x="14" y="14" width="7" height="7"></rect>
            <rect x="3" y="14" width="7" height="7"></rect>
      </div>
      <div class="ctx-section" data-scope="editor-tools">
        <div class="ctx-horiz-row">
          <button data-cmd="bold" title="Bold">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <path d="M6 4h8a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path>
              <path d="M6 12h9a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path>
            </svg>
          </button>
          <button data-cmd="italic" title="Italic">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <line x1="19" y1="4" x2="10" y2="4"></line>
              <line x1="14" y1="20" x2="5" y2="20"></line>
              <line x1="15" y1="4" x2="9" y2="20"></line>
            </svg>
          </button>
          <button data-cmd="h1" title="Heading 1">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <path d="M4 12h8m-8 6V6m8 12V6m5 6h4m-2-6v12"></path>
            </svg>
          </button>
          <button data-cmd="h2" title="Heading 2">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <path d="M4 12h8m-8 6V6m8 12V6m9 12h-4c0-4 4-3 4-6 0-1.5-2-2.5-4-1"></path>
            </svg>
          </button>
          <button data-cmd="h3" title="Heading 3">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <path
                d="M4 12h8m-8 6V6m8 12V6m5.5 4.5c.7-1.3 2.5-1.3 3.3 0 .3.6.1 1.2-.5 1.5l-1.3.3.3 1.3 1.3-.3c.6-.3.8-.9.5-1.5-.7-1.3-2.5-1.3-3.3 0">
              </path>
              <path
                d="M17.5 15.5c.7-1.3 2.5-1.3 3.3 0 .3.6.1 1.2-.5 1.5l-1.3.3.3 1.3 1.3-.3c.6-.3.8-.9.5-1.5-.7-1.3-2.5-1.3-3.3 0">
              </path>
            </svg>
          </button>
          <button data-cmd="highlight" title="Highlight">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <path
                d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 1 1 3.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z">
              </path>
              <line x1="3" y1="22" x2="21" y2="22"></line>
            </svg>
          </button>
        </div>
      </div>
      <div class="ctx-section" data-scope="editor-actions">
        <hr style="margin: 4px 0; border: none; border-top: 1px solid var(--border);" />
        <button data-cmd="undo">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 7v6h6" />
            <path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13" />
          </svg>
          Undo
        </button>
        <button data-cmd="redo">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 7v6h-6" />
            <path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3L21 13" />
          </svg>
          Redo
        </button>
        <hr style="margin: 4px 0; border: none; border-top: 1px solid var(--border);" />
        <button data-cmd="cut">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="6" cy="6" r="3"></circle>
            <circle cx="6" cy="18" r="3"></circle>
            <line x1="20" y1="4" x2="8.12" y2="15.88"></line>
            <line x1="14.47" y1="14.48" x2="20" y2="20"></line>
            <line x1="8.12" y1="8.12" x2="12" y2="12"></line>
          </svg>
          Cut
        </button>
        <button data-cmd="copy">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
          </svg>
          Copy
        </button>
        <button data-cmd="paste">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
            <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
          </svg>
          Paste
        </button>
        <button data-cmd="sketch">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <path d="M12 20h9" />
            <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z" />
          </svg>
          Insert Drawing
        </button>
        <hr style="margin: 4px 0; border: none; border-top: 1px solid var(--border);" />
        <button data-cmd="refresh-note" title="Refresh">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="23 4 23 10 17 10"></polyline>
            <polyline points="1 20 1 14 7 14"></polyline>
            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
          </svg>
          Refresh Note
        </button>
      </div>
      <div class="ctx-section" data-scope="sidebar">
        <button data-cmd="refresh-app">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="23 4 23 10 17 10"></polyline>
            <polyline points="1 20 1 14 7 14"></polyline>
            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
          </svg>
          Refresh
        </button>
        <hr style="
              margin: 4px 0;
              border: none;
              border-top: 1px solid var(--border);
            " />
        <button data-cmd="new-note">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="12" y1="18" x2="12" y2="12"></line>
            <line x1="9" y1="15" x2="15" y2="15"></line>
          </svg>
          New Note
        </button>
        <button data-cmd="new-folder">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
            <line x1="12" y1="11" x2="12" y2="17"></line>
            <line x1="9" y1="14" x2="15" y2="14"></line>
          </svg>
          New Folder
        </button>
        <button data-cmd="import-root">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
          Import
        </button>
      </div>
      <div class="ctx-section" data-scope="note">

        <button data-cmd="open-note">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="9" y1="3" x2="9" y2="21"></line>
          </svg>
          Open Note
        </button>
        <hr style="
              margin: 4px 0;
              border: none;
              border-top: 1px solid var(--border);
            " />
        <button data-cmd="rename-note">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
          </svg>
          Rename Note
        </button>
        <button data-cmd="export-note">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17 8 12 3 7 8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
          </svg>
          Export Note
        </button>
        <button data-cmd="show-in-explorer">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
          </svg>
          Show in File Explorer
        </button>
        <button data-cmd="duplicate">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
          </svg>
          Duplicate Note
        </button>
        <button data-cmd="toggle-pin">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 17v5"></path>
            <path d="M9 10V5a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v5"></path>
            <path d="M9 14h6"></path>
            <path d="M9 10h6a1 1 0 0 1 1 1v3H8v-3a1 1 0 0 1 1-1z"></path>
          </svg>
          <span class="pin-text">Pin Note</span>
        </button>
        <button data-cmd="move-to-root">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="9 14 4 9 9 4"></polyline>
            <path d="M20 20v-7a4 4 0 0 0-4-4H4"></path>
          </svg>
          Move to Uncategorized
        </button>
        <button data-cmd="delete-note">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="3 6 5 6 21 6"></polyline>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
          </svg>
          Delete Note
        </button>
      </div>
      <div class="ctx-section" data-scope="baselayer-note">
        <button data-cmd="open-note">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="9" y1="3" x2="9" y2="21"></line>
          </svg>
          Open Note
        </button>
        <hr style="
              margin: 4px 0;
              border: none;
              border-top: 1px solid var(--border);
            " />
        <button data-cmd="rename-note">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
          </svg>
          Rename Note
        </button>
        <button data-cmd="export-note">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17 8 12 3 7 8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
          </svg>
          Export Note
        </button>
        <button data-cmd="show-in-explorer">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
          </svg>
          Show in File Explorer
        </button>
        <button data-cmd="duplicate">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
          </svg>
          Duplicate Note
        </button>
        <button data-cmd="move-to-root">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="9 14 4 9 9 4"></polyline>
            <path d="M20 20v-7a4 4 0 0 0-4-4H4"></path>
          </svg>
          Move to Uncategorized
        </button>
        <button data-cmd="delete-note">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="3 6 5 6 21 6"></polyline>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
          </svg>
          Delete Note
        </button>
      </div>
      <div class="ctx-section" data-scope="multi-note">
        <button data-cmd="export-notes">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17 8 12 3 7 8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
          </svg>
          Export Selected Notes
        </button>
        <button data-cmd="delete-notes">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="3 6 5 6 21 6"></polyline>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
          </svg>
          Delete Selected Notes
        </button>
      </div>
      <div class="ctx-section" data-scope="pinned-note">
        <button data-cmd="open-note">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="9" y1="3" x2="9" y2="21"></line>
          </svg>
          Open Note
        </button>
        <hr style="
              margin: 4px 0;
              border: none;
              border-top: 1px solid var(--border);
            " />
        <button data-cmd="unpin-note">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 17v5"></path>
            <path d="M9 10V5a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v5"></path>
            <path d="M9 14h6"></path>
            <path d="M9 10h6a1 1 0 0 1 1 1v3H8v-3a1 1 0 0 1 1-1z"></path>
            <line x1="3" y1="3" x2="21" y2="21" stroke-width="2.5"></line>
          </svg>
          Unpin Note
        </button>
        <button data-cmd="unpin-others">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
          Unpin Others
        </button>
        <button data-cmd="unpin-all">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 6h18" />
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
            <line x1="10" y1="11" x2="10" y2="17"></line>
            <line x1="14" y1="11" x2="14" y2="17"></line>
          </svg>
          Unpin All
        </button>
        <hr style="
              margin: 4px 0;
              border: none;
              border-top: 1px solid var(--border);
            " />
        <button data-cmd="delete-pinned-note">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="3 6 5 6 21 6"></polyline>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
          </svg>
          Delete Note
        </button>
      </div>
      <div class="ctx-section" data-scope="folder">
        <button data-cmd="new-subfolder">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
            <line x1="12" y1="11" x2="12" y2="17"></line>
            <line x1="9" y1="14" x2="15" y2="14"></line>
          </svg>
          New Subfolder
        </button>
        <button data-cmd="new-note-to-folder">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="12" y1="11" x2="12" y2="17"></line>
            <line x1="9" y1="14" x2="15" y2="14"></line>
          </svg>
          New Note
        </button>
        <hr style="
              margin: 4px 0;
              border: none;
              border-top: 1px solid var(--border);
            " />
        <button data-cmd="rename-folder">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
          </svg>
          Rename Folder
        </button>
        <button data-cmd="export-folder">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17 8 12 3 7 8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
          </svg>
          Export Folder
        </button>
        <button data-cmd="show-in-explorer">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
          </svg>
          Show in File Explorer
        </button>
        <button data-cmd="duplicate">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
          </svg>
          Duplicate Folder
        </button>
        <button data-cmd="import-to-folder">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
          Import to Folder
        </button>
        <button data-cmd="move-to-root">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="9 14 4 9 9 4"></polyline>
            <path d="M20 20v-7a4 4 0 0 0-4-4H4"></path>
          </svg>
          Move to Root
        </button>
        <button data-cmd="delete-folder">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="3 6 5 6 21 6"></polyline>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
          </svg>
          Delete Folder
        </button>
      </div>
      <div class="ctx-section" data-scope="empty-space">
        <button data-cmd="refresh-app">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="23 4 23 10 17 10"></polyline>
            <polyline points="1 20 1 14 7 14"></polyline>
            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
          </svg>
          Refresh
        </button>
        <hr style="
              margin: 4px 0;
              border: none;
              border-top: 1px solid var(--border);
            " />
        <button data-cmd="new-note">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="12" y1="18" x2="12" y2="12"></line>
            <line x1="9" y1="15" x2="15" y2="15"></line>
          </svg>
          New Note
        </button>
        <button data-cmd="new-folder">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
            <line x1="12" y1="11" x2="12" y2="17"></line>
            <line x1="9" y1="14" x2="15" y2="14"></line>
          </svg>
          New Folder
        </button>
        <button data-cmd="import-root">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
          Import
        </button>
      </div>
      <div class="ctx-section" data-scope="empty-space-uncategorized">
        <button data-cmd="refresh-app">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="23 4 23 10 17 10"></polyline>
            <polyline points="1 20 1 14 7 14"></polyline>
            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
          </svg>
          Refresh
        </button>
        <hr style="
              margin: 4px 0;
              border: none;
              border-top: 1px solid var(--border);
            " />
        <button data-cmd="new-note">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="12" y1="18" x2="12" y2="12"></line>
            <line x1="9" y1="15" x2="15" y2="15"></line>
          </svg>
          New Note
        </button>
        <button data-cmd="import-root">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
          Import
        </button>
      </div>
    </div>
  </template>

  <template id="modal-template">
    <div class="modal-overlay">
      <div class="modal">
        <div class="modal-header">
          <span class="modal-title"></span>
        </div>
        <div class="modal-body"></div>
        <div class="modal-actions"></div>
      </div>
    </div>
  </template>

  <template id="search-results-template">
    <div class="search-results-modal">
      <div class="search-results-header">
        <h3>Search Results</h3>
        <button class="close-search-results">×</button>
      </div>
      <div class="search-results-query"></div>
      <div class="search-results-content"></div>
    </div>
  </template>

  <template id="note-editor-template">
    <div class="editor">
      <div class="editor-header">
        <div class="title-with-tags">
          <input class="title" placeholder="Title" />
          <div class="header-tags"></div>
        </div>
        <span class="title-status"
          style="margin-left: auto; margin-right: 12px; font-size: 11px; color: black; white-space: nowrap;"></span>
        <div class="actions">
          <div class="editor-menu">
            <button class="editor-menu-btn" title="More options">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
              </svg>
            </button>
            <div class="editor-menu-list">
              <div class="editor-menu-section">
                <div class="label">Font Size</div>
                <div class="font-controls-menu">
                  <button data-action="font-decrease" title="Decrease font size">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                  </button>
                  <span class="font-size-label">16px</span>
                  <button data-action="font-increase" title="Increase font size">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="12" y1="5" x2="12" y2="19"></line>
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                  </button>
                </div>
              </div>
              <div class="editor-menu-section">
                <div class="label">Font Family</div>
                <div class="font-controls-menu">
                  <select class="font-family-select" title="Change editor font">
                    <option value="system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif">
                      System Default
                    </option>
                    <option value="Arial, sans-serif" selected>Arial</option>
                    <option value="'Segoe UI', Tahoma, Geneva, Verdana, sans-serif">
                      Segoe UI
                    </option>
                    <option value="'Georgia', 'Times New Roman', serif">
                      Georgia
                    </option>
                    <option value="'Courier New', Courier, monospace">
                      Monospace
                    </option>
                  </select>
                </div>
              </div>
              <hr />
              <button data-action="toggle-layout" class="menu-item">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="6" y="4" width="12" height="16" rx="2" ry="2" stroke="currentColor" stroke-width="2"
                    fill="none"></rect>
                  <line x1="6" y1="8" x2="18" y2="8" stroke="currentColor" stroke-width="2"></line>
                  <line x1="6" y1="12" x2="18" y2="12" stroke="currentColor" stroke-width="2"></line>
                </svg>
                <span class="layout-label">Centered Layout</span>
              </button>
              <button data-action="lock-note" class="menu-item editor-lock-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                  <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                </svg>
                <span class="lock-label">Lock Note (Ctrl+L)</span>
              </button>
              <hr />
              <button data-action="folder-tags" class="menu-item">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                  <line x1="7" y1="7" x2="7.01" y2="7"></line>
                </svg>
                Folder & Tags
              </button>
            </div>
          </div>
          <div class="settings-dropdown" style="display: none">
            <div class="settings-section">
              <label>Folder</label>
              <select class="folder-dropdown"></select>
            </div>
            <div class="settings-section">
              <label>Tags</label>
              <div class="tags-dropdown chips"></div>
              <input class="tag-input-dropdown" placeholder="Add tag…" />
            </div>
          </div>
        </div>
      </div>
      <div class="meta" style="display: none">
        <select class="folder"></select>
        <div class="tags chips"></div>
        <input class="tag-input" placeholder="Add tag…" />
      </div>
      <div class="content editable" contenteditable="true" spellcheck="false" placeholder="Start typing..."></div>
    </div>
  </template>

  <template id="window-template">
    <div class="window" style="left: 120px; top: 120px; width: 480px; height: 360px">
      <div class="window-title">
        <span class="window-name"></span>
        <div class="window-controls">
          <button data-action="minimize" title="Minimize">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
          </button>
          <button data-action="close" title="Close">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
      </div>
      <div class="window-body"></div>
    </div>
  </template>

  <template id="browser-template">
    <div class="browser-container">
      <div class="browser-toolbar">
        <button class="browser-nav-btn" data-action="back" title="Back">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
        </button>
        <button class="browser-nav-btn" data-action="forward" title="Forward">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="9 18 15 12 9 6"></polyline>
          </svg>
        </button>
        <button class="browser-nav-btn" data-action="refresh" title="Refresh">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="23 4 23 10 17 10"></polyline>
            <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
          </svg>
        </button>
        <input type="text" class="browser-url-bar" placeholder="Enter URL or search..." />
        <button class="browser-nav-btn" data-action="go" title="Go">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="9 18 15 12 9 6"></polyline>
          </svg>
        </button>
        <button class="browser-nav-btn" data-action="open-external" title="Open in External Browser">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
            <polyline points="15 3 21 3 21 9"></polyline>
            <line x1="10" y1="14" x2="21" y2="3"></line>
          </svg>
        </button>
      </div>
      <div class="browser-content">
        <div class="browser-message">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10" />
            <circle cx="12" cy="12" r="4" />
            <line x1="21.17" y1="8" x2="12" y2="8" />
            <line x1="3.95" y1="6.06" x2="8.54" y2="14" />
            <line x1="10.88" y1="21.94" x2="15.46" y2="14" />
          </svg>
          <h3>Loading DuckDuckGo...</h3>
          <p>Built-in browser powered by DuckDuckGo HTML</p>
          <p class="browser-note">
            Note: Some sites block embedding. Click the external link icon to
            open in your default browser.
          </p>
        </div>
        <iframe class="browser-frame" style="display: none"></iframe>
      </div>
    </div>
  </template>

  <!-- File System Service initialization -->
  <script type="module">
    import fileSystemService from "./scripts/file-system-service.js";

    // Wrap everything in an async function to handle the return statement properly
    (async function initializeApp() {
      // Make fileSystemService globally available FIRST
      window.fileSystemService = fileSystemService;

      // Wait for port discovery to complete
      await fileSystemService.waitForReady();

      // Check if file system server is running
      const serverStatus = await fileSystemService.checkHealth();

      const statusEl = document.getElementById("connectionStatus");
      const statusIcon = document.getElementById("statusIcon");
      const statusText = document.getElementById("connectionStatusText");

      if (statusEl) {
        // Suppress legacy UI
        statusEl.style.display = "none";
        
        if (!serverStatus) {
          console.warn("Server not running - starting in offline/limited mode");
          showToast("Offline Mode - Server disconnected", "error", 4000);
        } else {
          console.log("File system service connected successfully");
          showToast("Synced - Services and notes connected", "success", 4000);
        }
      }

      // Initialize click-to-close for status dialog
      if (statusEl) {
        statusEl.onclick = () => {
          statusEl.style.transform = "translateY(100px)";
          statusEl.style.opacity = "0";
          statusEl.style.pointerEvents = "none";
        };
      }

      // Setup backup button
      const backupBtn = document.getElementById("backupToFileSystemBtn");
      if (backupBtn) {
        backupBtn.addEventListener("click", async () => {
          const settingsMenu = document.getElementById("settingsMenu");
          if (settingsMenu) {
            settingsMenu.classList.remove("open");
          }

          // Show status via new notification system
          showToast("Creating backup file...", "info", 5000);

          try {
            // Create backup using the server endpoint
            const result = await fileSystemService.createBackup();
            showToast(`Backup saved: ${result.backupFile}`, "success", 5000);
          } catch (error) {
            console.error("Backup failed:", error);
            showToast("Backup failed. Please try again.", "error", 5000);
          }
        });
      }

      // Setup "Open Notes Folder" button
      const openFileLocationBtn = document.getElementById(
        "openFileLocationBtn"
      );
      if (openFileLocationBtn) {
        openFileLocationBtn.addEventListener("click", () => {
          const settingsMenu = document.getElementById("settingsMenu");
          if (settingsMenu) {
            settingsMenu.classList.remove("open");
          }

          // Try to open the folder in Windows Explorer
          if (window.electronAPI) {
            // If running in Electron, use shell.openPath
            window.electronAPI.openPath("D:\\MyNotes");
          } else {
            // For web version, show instructions
            alert(
              "Notes are stored in: D:\\MyNotes\\n\\nOpen File Explorer and navigate to this folder to see your notes as JSON files."
            );
          }
        });
      }

      // Update note count in storage info
      function updateNoteCount() {
        const noteCountEl = document.getElementById("noteCount");
        if (noteCountEl && window.state) {
          const noteCount = window.state.notes
            ? window.state.notes.length
            : 0;
          const folderCount = window.state.folders
            ? window.state.folders.length
            : 0;
          const trashCount = window.state.trash
            ? window.state.trash.length
            : 0;

          noteCountEl.textContent = `${noteCount} notes, ${folderCount} folders, ${trashCount} in trash`;
        }
      }

      // Setup welcome customization
      const welcomeCustomizationBtn = document.getElementById(
        "welcomeCustomizationBtn"
      );
      if (
        welcomeCustomizationBtn &&
        typeof window.WelcomeCustomization !== "undefined"
      ) {
        welcomeCustomizationBtn.addEventListener("click", () => {
          const settingsMenu = document.getElementById("settingsMenu");
          if (settingsMenu) {
            settingsMenu.classList.remove("open");
          }
          window.WelcomeCustomization.showCustomizationModal();
        });
      }

      // Setup export notes button
      const exportNotesBtn = document.querySelector(
        ".editor-export-notes-btn"
      );
      if (exportNotesBtn) {
        exportNotesBtn.addEventListener("click", () => {
          const settingsMenu = document.getElementById("settingsMenu");
          if (settingsMenu) {
            settingsMenu.classList.remove("open");
          }

          // Trigger the existing export functionality
          const exportBtn = document.getElementById("exportBtn");
          if (exportBtn) {
            exportBtn.click();
          }
        });
      }

      // Function to add log messages to the debug modal and loader
      const debugLogOutput = document.getElementById('debugLogOutput');
      function addLog(msg) {
        if (debugLogOutput) {
          const line = document.createElement('div');
          line.textContent = msg;
          line.style.borderBottom = '1px solid #333';
          line.style.padding = '2px 0';
          debugLogOutput.appendChild(line);
          // Auto-scroll logic
          setTimeout(() => {
            debugLogOutput.scrollTop = debugLogOutput.scrollHeight;
          }, 10);
        }

        // Also add to loader logs
        const loaderLogContainer = document.getElementById('loaderLogContainer');
        if (loaderLogContainer) {
          const line = document.createElement('div');
          line.textContent = '> ' + msg;
          line.style.whiteSpace = 'nowrap';
          line.style.overflow = 'hidden';
          line.style.textOverflow = 'ellipsis';
          loaderLogContainer.appendChild(line);
          // Keep only last 4 lines
          while (loaderLogContainer.children.length > 4) {
            loaderLogContainer.removeChild(loaderLogContainer.firstChild);
          }
        }
      }

      // Setup import notes button
      const importNotesBtn = document.querySelector(".editor-import-btn");
      if (importNotesBtn) {
        importNotesBtn.addEventListener("click", () => {
          const settingsMenu = document.getElementById("settingsMenu");
          if (settingsMenu) {
            settingsMenu.classList.remove("open");
          }

          // Trigger the existing import functionality
          const importBtn = document.getElementById("importBtn");
          if (importBtn) {
            importBtn.click();
          }
        });
      }

      // Setup trash button
      const trashBtn = document.querySelector(".editor-trash-btn");
      if (trashBtn) {
        trashBtn.addEventListener("click", () => {
          const settingsMenu = document.getElementById("settingsMenu");
          if (settingsMenu) {
            settingsMenu.classList.remove("open");
          }

          // Trigger the existing trash functionality
          const mainTrashBtn = document.getElementById("trashBtn");
          if (mainTrashBtn) {
            mainTrashBtn.click();
          }
        });
      }

      // Add verification function to prove notes are on file system
      window.verifyFileSystemStorage = async function () {
        try {
          const response = await fileSystemService.makeRequest("/notes");
          const fileSystemNotes = response || [];

          console.log(
            "VERIFICATION: Notes on file system:",
            fileSystemNotes.length
          );
          console.log(
            "File system notes:",
            fileSystemNotes.map((n) => ({
              id: n.id,
              title: n.title,
              createdAt: n.createdAt,
            }))
          );

          // Clear browser storage to prove we're not using it
          localStorage.clear();
          sessionStorage.clear();
          console.log(
            "🧹 Browser storage cleared - notes still available from D:\\MyNotes"
          );

          return fileSystemNotes;
        } catch (error) {
          console.error("❌ File system verification failed:", error);
          return null;
        }
      };

      // Show verification in console
      console.log("🔒 ANTI-PRANK PROTECTION ACTIVE:");
      console.log("✅ Notes saved ONLY to D:\\MyNotes (not browser cache)");
      console.log("✅ Run window.verifyFileSystemStorage() to verify");
      console.log("✅ Browser storage cleared on each verification");

      // Apply theme early to prevent flash
      async function applyEarlyTheme() {
        try {
          // Clear old localStorage theme data to prevent conflicts
          localStorage.removeItem("notes.theme");

          const response = await fileSystemService.makeRequest("/settings");
          const settings = response || {};
          const theme = settings.theme || "dark";

          // Remove all theme classes
          document.body.classList.remove("theme-light");

          // Apply theme (dark is default, no class needed)
          if (theme !== "dark") {
            document.body.classList.add(`theme-${theme}`);
          }

          console.log("🎨 Theme applied early:", theme);
        } catch (error) {
          console.log("🎨 Using default theme (dark)");
          // Default is dark theme, no class needed
        }
      }

      // Apply theme before loading the app
      await applyEarlyTheme();

      // Make updateNoteCount globally available
      window.updateNoteCount = updateNoteCount;

      // Now load the main app
      await import("./scripts/app.js");

      // Wait for app to finish loading notes then restore session
      // app.js is async, but we can't await its internal IIFE easily.
      // Instead, we will augment app.js to trigger a custom event or we can rely on 
      // app.js having a global 'window.appReady' promise if we made one?
      // Or better yet, just modify app.js to call restoreTwoBaseSession().
    })();
  </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Add PDF.js for reading PDF content -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Set worker source for PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="scripts/markdown.js"></script>
  <script src="scripts/two-base.js"></script>
  <script src="scripts/two-base-persistence.js"></script>
  <script src="scripts/question-base.js?v=3"></script>
  <script src="scripts/custom-features.js"></script>
  <script src="scripts/note-font-handler.js"></script>
  <script src="scripts/dungeon-note.js"></script>
  <script type="module">
    import DungeonBase from './scripts/dungeon-base.js';
    window.DungeonBase = new DungeonBase();
    window.DungeonBase.init();
  </script>

  <!-- Debug Log Modal -->
  <div id="debugLogModal" class="modal-overlay" style="display: none; z-index: 2000;">
    <div class="modal-content debug-log-content"
      style="background: #1e1e1e; border: 1px solid #333; color: #00ff00; font-family: 'Consolas', monospace; max-width: 800px; width: 90%; height: 500px; display: flex; flex-direction: column;">
      <div class="modal-header"
        style="border-bottom: 1px solid #333; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center;">
        <h3 style="color: #00ff00; margin: 0; font-size: 16px;">> System Startup Log</h3>
        <button id="closeDebugLogBtn"
          style="background: none; border: none; color: #00ff00; font-size: 24px; cursor: pointer;">&times;</button>
      </div>
      <div class="modal-body" style="padding: 0; flex: 1; overflow: hidden; display: flex;">
        <div id="debugLogOutput"
          style="width: 100%; height: 100%; overflow-y: auto; padding: 1rem; white-space: pre-wrap; font-size: 13px; scrollbar-width: thin; scrollbar-color: #333 #1e1e1e;">
        </div>
      </div>
    </div>
  </div>
    <!-- AI Prompt Viewer Modal -->
    <div id="aiPromptModal" class="custom-modal ai-modal" style="display: none;">
      <div class="custom-modal-content">
        <div class="custom-modal-header">
          <h3>AI System Prompt</h3>
          <button class="close-modal">&times;</button>
        </div>
        <div class="custom-modal-body">
          <pre id="promptTextArea" class="prompt-display"></pre>
        </div>
        <div class="custom-modal-footer">
          <button class="btn secondary close-modal">Close</button>
        </div>
      </div>
    </div>

    <!-- Notification Center -->
    <div id="notifCenter" class="notif-center-trigger" title="Notifications">
        <svg id="notifBellSvg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
        </svg>
        <div id="notifCount" class="notif-count hidden">0</div>
    </div>


    <!-- Notification Pane -->
    <div id="notifPane" class="notif-pane hidden">
        <div class="notif-pane-header">
            <h3>Notifications</h3>
            <div class="notif-pane-actions">
                <button id="dndToggleBtn" class="dnd-toggle-btn" title="Do Not Disturb: Off">
                    <svg id="dndBellSvg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                    </svg>
                </button>
                <button id="clearNotifsBtn" class="clear-notifs-btn">Clear All</button>
            </div>
        </div>
        <div id="notifList" class="notif-list">
            <!-- Notifications will be injected here -->
            <div class="notif-empty-state">No new notifications</div>
        </div>
    </div>
  </body>

</html>